function _t(t,e,r){if(!t||typeof t!="object"||!e||typeof e!="object")throw new Error("both arguments must be objects or arrays");r||(r=function(a){return a});function o({obj1:a,obj2:p,basePath:m,basePathForRemoves:j,diffs:h}){var y=Object.keys(a),b=y.length,c=Object.keys(p),R=c.length,g,v=a.length-p.length;if(lr(a,p)){for(var d=0;d<b;d++){var B=Array.isArray(a)?Number(y[d]):y[d];B in p||(g=j.concat(B),h.remove.push({op:"remove",path:r(g)}))}for(var d=0;d<R;d++){var B=Array.isArray(p)?Number(c[d]):c[d];i({key:B,obj1:a,obj2:p,path:m.concat(B),pathForRemoves:m.concat(B),diffs:h})}}else{for(var d=0;d<v;d++)g=j.concat(d),h.remove.push({op:"remove",path:r(g)});for(var nr=a.slice(v),d=0;d<R;d++)i({key:d,obj1:nr,obj2:p,path:m.concat(d),pathForRemoves:m.concat(d+v),diffs:h})}}var s={remove:[],replace:[],add:[]};return o({obj1:t,obj2:e,basePath:[],basePathForRemoves:[],diffs:s}),s.remove.reverse().concat(s.replace).concat(s.add);function i({key:a,obj1:p,obj2:m,path:j,pathForRemoves:h,diffs:y}){var b=p[a],c=m[a];if(!(a in p)&&a in m){var R=c;y.add.push({op:"add",path:r(j),value:R})}else b!==c&&(Object(b)!==b||Object(c)!==c||pr(b,c)||!Object.keys(b).length&&!Object.keys(c).length&&String(b)!=String(c)?f(j,y,c):o({obj1:p[a],obj2:m[a],basePath:j,basePathForRemoves:h,diffs:y}))}function f(a,p,m){p.replace.push({op:"replace",path:r(a),value:m})}}function Pt(t){return[""].concat(t).join("/")}function pr(t,e){return Object.prototype.toString.call(t)!=Object.prototype.toString.call(e)}function lr(t,e){var r=t.length-e.length;if(Array.isArray(t)&&Array.isArray(e)&&r>0){for(var o=0,s=0,i=0;i<e.length&&String(t[i])===String(e[i]);i++)o++;for(var f=e.length;f>0&&String(t[f+r])===String(e[f]);f--)s++;return o>=s}return!0}var mr=typeof global=="object"&&global&&global.Object===Object&&global,X=mr;var ur=typeof self=="object"&&self&&self.Object===Object&&self,dr=X||ur||Function("return this")(),u=dr;var cr=u.Symbol,A=cr;var St=Object.prototype,xr=St.hasOwnProperty,hr=St.toString,Y=A?A.toStringTag:void 0;function gr(t){var e=xr.call(t,Y),r=t[Y];try{t[Y]=void 0;var o=!0}catch{}var s=hr.call(t);return o&&(e?t[Y]=r:delete t[Y]),s}var It=gr;var yr=Object.prototype,br=yr.toString;function vr(t){return br.call(t)}var Ct=vr;var jr="[object Null]",wr="[object Undefined]",Et=A?A.toStringTag:void 0;function Tr(t){return t==null?t===void 0?wr:jr:Et&&Et in Object(t)?It(t):Ct(t)}var O=Tr;function Ar(t){return t!=null&&typeof t=="object"}var w=Ar;var Or=Array.isArray,D=Or;function _r(t){var e=typeof t;return t!=null&&(e=="object"||e=="function")}var T=_r;var Pr="[object AsyncFunction]",Sr="[object Function]",Ir="[object GeneratorFunction]",Cr="[object Proxy]";function Er(t){if(!T(t))return!1;var e=O(t);return e==Sr||e==Ir||e==Pr||e==Cr}var Z=Er;var Lr=u["__core-js_shared__"],Q=Lr;var Lt=function(){var t=/[^.]+$/.exec(Q&&Q.keys&&Q.keys.IE_PROTO||"");return t?"Symbol(src)_1."+t:""}();function Mr(t){return!!Lt&&Lt in t}var Mt=Mr;var Rr=Function.prototype,Fr=Rr.toString;function Br(t){if(t!=null){try{return Fr.call(t)}catch{}try{return t+""}catch{}}return""}var _=Br;var Dr=/[\\^$.*+?()[\]{}|]/g,Nr=/^\[object .+?Constructor\]$/,Ur=Function.prototype,Wr=Object.prototype,Gr=Ur.toString,kr=Wr.hasOwnProperty,Kr=RegExp("^"+Gr.call(kr).replace(Dr,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function zr(t){if(!T(t)||Mt(t))return!1;var e=Z(t)?Kr:Nr;return e.test(_(t))}var Rt=zr;function Vr(t,e){return t?.[e]}var Ft=Vr;function Hr(t,e){var r=Ft(t,e);return Rt(r)?r:void 0}var x=Hr;var qr=x(u,"WeakMap"),tt=qr;var Bt=Object.create,$r=function(){function t(){}return function(e){if(!T(e))return{};if(Bt)return Bt(e);t.prototype=e;var r=new t;return t.prototype=void 0,r}}(),Dt=$r;function Yr(t,e){var r=-1,o=t.length;for(e||(e=Array(o));++r<o;)e[r]=t[r];return e}var Nt=Yr;var Jr=function(){try{var t=x(Object,"defineProperty");return t({},"",{}),t}catch{}}(),yt=Jr;function Xr(t,e){for(var r=-1,o=t==null?0:t.length;++r<o&&e(t[r],r,t)!==!1;);return t}var Ut=Xr;var Zr=9007199254740991,Qr=/^(?:0|[1-9]\d*)$/;function to(t,e){var r=typeof t;return e=e??Zr,!!e&&(r=="number"||r!="symbol"&&Qr.test(t))&&t>-1&&t%1==0&&t<e}var Wt=to;function eo(t,e,r){e=="__proto__"&&yt?yt(t,e,{configurable:!0,enumerable:!0,value:r,writable:!0}):t[e]=r}var et=eo;function ro(t,e){return t===e||t!==t&&e!==e}var rt=ro;var oo=Object.prototype,ao=oo.hasOwnProperty;function fo(t,e,r){var o=t[e];(!(ao.call(t,e)&&rt(o,r))||r===void 0&&!(e in t))&&et(t,e,r)}var ot=fo;function so(t,e,r,o){var s=!r;r||(r={});for(var i=-1,f=e.length;++i<f;){var a=e[i],p=o?o(r[a],t[a],a,r,t):void 0;p===void 0&&(p=t[a]),s?et(r,a,p):ot(r,a,p)}return r}var I=so;var io=9007199254740991;function no(t){return typeof t=="number"&&t>-1&&t%1==0&&t<=io}var at=no;function po(t){return t!=null&&at(t.length)&&!Z(t)}var ft=po;var lo=Object.prototype;function mo(t){var e=t&&t.constructor,r=typeof e=="function"&&e.prototype||lo;return t===r}var N=mo;function uo(t,e){for(var r=-1,o=Array(t);++r<t;)o[r]=e(r);return o}var Gt=uo;var co="[object Arguments]";function xo(t){return w(t)&&O(t)==co}var bt=xo;var kt=Object.prototype,ho=kt.hasOwnProperty,go=kt.propertyIsEnumerable,yo=bt(function(){return arguments}())?bt:function(t){return w(t)&&ho.call(t,"callee")&&!go.call(t,"callee")},Kt=yo;function bo(){return!1}var zt=bo;var qt=typeof exports=="object"&&exports&&!exports.nodeType&&exports,Vt=qt&&typeof module=="object"&&module&&!module.nodeType&&module,vo=Vt&&Vt.exports===qt,Ht=vo?u.Buffer:void 0,jo=Ht?Ht.isBuffer:void 0,wo=jo||zt,st=wo;var To="[object Arguments]",Ao="[object Array]",Oo="[object Boolean]",_o="[object Date]",Po="[object Error]",So="[object Function]",Io="[object Map]",Co="[object Number]",Eo="[object Object]",Lo="[object RegExp]",Mo="[object Set]",Ro="[object String]",Fo="[object WeakMap]",Bo="[object ArrayBuffer]",Do="[object DataView]",No="[object Float32Array]",Uo="[object Float64Array]",Wo="[object Int8Array]",Go="[object Int16Array]",ko="[object Int32Array]",Ko="[object Uint8Array]",zo="[object Uint8ClampedArray]",Vo="[object Uint16Array]",Ho="[object Uint32Array]",l={};l[No]=l[Uo]=l[Wo]=l[Go]=l[ko]=l[Ko]=l[zo]=l[Vo]=l[Ho]=!0;l[To]=l[Ao]=l[Bo]=l[Oo]=l[Do]=l[_o]=l[Po]=l[So]=l[Io]=l[Co]=l[Eo]=l[Lo]=l[Mo]=l[Ro]=l[Fo]=!1;function qo(t){return w(t)&&at(t.length)&&!!l[O(t)]}var $t=qo;function $o(t){return function(e){return t(e)}}var U=$o;var Yt=typeof exports=="object"&&exports&&!exports.nodeType&&exports,J=Yt&&typeof module=="object"&&module&&!module.nodeType&&module,Yo=J&&J.exports===Yt,vt=Yo&&X.process,Jo=function(){try{var t=J&&J.require&&J.require("util").types;return t||vt&&vt.binding&&vt.binding("util")}catch{}}(),P=Jo;var Jt=P&&P.isTypedArray,Xo=Jt?U(Jt):$t,Xt=Xo;var Zo=Object.prototype,Qo=Zo.hasOwnProperty;function ta(t,e){var r=D(t),o=!r&&Kt(t),s=!r&&!o&&st(t),i=!r&&!o&&!s&&Xt(t),f=r||o||s||i,a=f?Gt(t.length,String):[],p=a.length;for(var m in t)(e||Qo.call(t,m))&&!(f&&(m=="length"||s&&(m=="offset"||m=="parent")||i&&(m=="buffer"||m=="byteLength"||m=="byteOffset")||Wt(m,p)))&&a.push(m);return a}var it=ta;function ea(t,e){return function(r){return t(e(r))}}var nt=ea;var ra=nt(Object.keys,Object),Zt=ra;var oa=Object.prototype,aa=oa.hasOwnProperty;function fa(t){if(!N(t))return Zt(t);var e=[];for(var r in Object(t))aa.call(t,r)&&r!="constructor"&&e.push(r);return e}var Qt=fa;function sa(t){return ft(t)?it(t):Qt(t)}var W=sa;function ia(t){var e=[];if(t!=null)for(var r in Object(t))e.push(r);return e}var te=ia;var na=Object.prototype,pa=na.hasOwnProperty;function la(t){if(!T(t))return te(t);var e=N(t),r=[];for(var o in t)o=="constructor"&&(e||!pa.call(t,o))||r.push(o);return r}var ee=la;function ma(t){return ft(t)?it(t,!0):ee(t)}var G=ma;var ua=x(Object,"create"),S=ua;function da(){this.__data__=S?S(null):{},this.size=0}var re=da;function ca(t){var e=this.has(t)&&delete this.__data__[t];return this.size-=e?1:0,e}var oe=ca;var xa="__lodash_hash_undefined__",ha=Object.prototype,ga=ha.hasOwnProperty;function ya(t){var e=this.__data__;if(S){var r=e[t];return r===xa?void 0:r}return ga.call(e,t)?e[t]:void 0}var ae=ya;var ba=Object.prototype,va=ba.hasOwnProperty;function ja(t){var e=this.__data__;return S?e[t]!==void 0:va.call(e,t)}var fe=ja;var wa="__lodash_hash_undefined__";function Ta(t,e){var r=this.__data__;return this.size+=this.has(t)?0:1,r[t]=S&&e===void 0?wa:e,this}var se=Ta;function k(t){var e=-1,r=t==null?0:t.length;for(this.clear();++e<r;){var o=t[e];this.set(o[0],o[1])}}k.prototype.clear=re;k.prototype.delete=oe;k.prototype.get=ae;k.prototype.has=fe;k.prototype.set=se;var jt=k;function Aa(){this.__data__=[],this.size=0}var ie=Aa;function Oa(t,e){for(var r=t.length;r--;)if(rt(t[r][0],e))return r;return-1}var C=Oa;var _a=Array.prototype,Pa=_a.splice;function Sa(t){var e=this.__data__,r=C(e,t);if(r<0)return!1;var o=e.length-1;return r==o?e.pop():Pa.call(e,r,1),--this.size,!0}var ne=Sa;function Ia(t){var e=this.__data__,r=C(e,t);return r<0?void 0:e[r][1]}var pe=Ia;function Ca(t){return C(this.__data__,t)>-1}var le=Ca;function Ea(t,e){var r=this.__data__,o=C(r,t);return o<0?(++this.size,r.push([t,e])):r[o][1]=e,this}var me=Ea;function K(t){var e=-1,r=t==null?0:t.length;for(this.clear();++e<r;){var o=t[e];this.set(o[0],o[1])}}K.prototype.clear=ie;K.prototype.delete=ne;K.prototype.get=pe;K.prototype.has=le;K.prototype.set=me;var E=K;var La=x(u,"Map"),L=La;function Ma(){this.size=0,this.__data__={hash:new jt,map:new(L||E),string:new jt}}var ue=Ma;function Ra(t){var e=typeof t;return e=="string"||e=="number"||e=="symbol"||e=="boolean"?t!=="__proto__":t===null}var de=Ra;function Fa(t,e){var r=t.__data__;return de(e)?r[typeof e=="string"?"string":"hash"]:r.map}var M=Fa;function Ba(t){var e=M(this,t).delete(t);return this.size-=e?1:0,e}var ce=Ba;function Da(t){return M(this,t).get(t)}var xe=Da;function Na(t){return M(this,t).has(t)}var he=Na;function Ua(t,e){var r=M(this,t),o=r.size;return r.set(t,e),this.size+=r.size==o?0:1,this}var ge=Ua;function z(t){var e=-1,r=t==null?0:t.length;for(this.clear();++e<r;){var o=t[e];this.set(o[0],o[1])}}z.prototype.clear=ue;z.prototype.delete=ce;z.prototype.get=xe;z.prototype.has=he;z.prototype.set=ge;var ye=z;function Wa(t,e){for(var r=-1,o=e.length,s=t.length;++r<o;)t[s+r]=e[r];return t}var pt=Wa;var Ga=nt(Object.getPrototypeOf,Object),lt=Ga;function ka(){this.__data__=new E,this.size=0}var be=ka;function Ka(t){var e=this.__data__,r=e.delete(t);return this.size=e.size,r}var ve=Ka;function za(t){return this.__data__.get(t)}var je=za;function Va(t){return this.__data__.has(t)}var we=Va;var Ha=200;function qa(t,e){var r=this.__data__;if(r instanceof E){var o=r.__data__;if(!L||o.length<Ha-1)return o.push([t,e]),this.size=++r.size,this;r=this.__data__=new ye(o)}return r.set(t,e),this.size=r.size,this}var Te=qa;function V(t){var e=this.__data__=new E(t);this.size=e.size}V.prototype.clear=be;V.prototype.delete=ve;V.prototype.get=je;V.prototype.has=we;V.prototype.set=Te;var Ae=V;function $a(t,e){return t&&I(e,W(e),t)}var Oe=$a;function Ya(t,e){return t&&I(e,G(e),t)}var _e=Ya;var Ce=typeof exports=="object"&&exports&&!exports.nodeType&&exports,Pe=Ce&&typeof module=="object"&&module&&!module.nodeType&&module,Ja=Pe&&Pe.exports===Ce,Se=Ja?u.Buffer:void 0,Ie=Se?Se.allocUnsafe:void 0;function Xa(t,e){if(e)return t.slice();var r=t.length,o=Ie?Ie(r):new t.constructor(r);return t.copy(o),o}var Ee=Xa;function Za(t,e){for(var r=-1,o=t==null?0:t.length,s=0,i=[];++r<o;){var f=t[r];e(f,r,t)&&(i[s++]=f)}return i}var Le=Za;function Qa(){return[]}var mt=Qa;var tf=Object.prototype,ef=tf.propertyIsEnumerable,Me=Object.getOwnPropertySymbols,rf=Me?function(t){return t==null?[]:(t=Object(t),Le(Me(t),function(e){return ef.call(t,e)}))}:mt,H=rf;function of(t,e){return I(t,H(t),e)}var Re=of;var af=Object.getOwnPropertySymbols,ff=af?function(t){for(var e=[];t;)pt(e,H(t)),t=lt(t);return e}:mt,ut=ff;function sf(t,e){return I(t,ut(t),e)}var Fe=sf;function nf(t,e,r){var o=e(t);return D(t)?o:pt(o,r(t))}var dt=nf;function pf(t){return dt(t,W,H)}var Be=pf;function lf(t){return dt(t,G,ut)}var De=lf;var mf=x(u,"DataView"),ct=mf;var uf=x(u,"Promise"),xt=uf;var df=x(u,"Set"),ht=df;var Ne="[object Map]",cf="[object Object]",Ue="[object Promise]",We="[object Set]",Ge="[object WeakMap]",ke="[object DataView]",xf=_(ct),hf=_(L),gf=_(xt),yf=_(ht),bf=_(tt),F=O;(ct&&F(new ct(new ArrayBuffer(1)))!=ke||L&&F(new L)!=Ne||xt&&F(xt.resolve())!=Ue||ht&&F(new ht)!=We||tt&&F(new tt)!=Ge)&&(F=function(t){var e=O(t),r=e==cf?t.constructor:void 0,o=r?_(r):"";if(o)switch(o){case xf:return ke;case hf:return Ne;case gf:return Ue;case yf:return We;case bf:return Ge}return e});var q=F;var vf=Object.prototype,jf=vf.hasOwnProperty;function wf(t){var e=t.length,r=new t.constructor(e);return e&&typeof t[0]=="string"&&jf.call(t,"index")&&(r.index=t.index,r.input=t.input),r}var Ke=wf;var Tf=u.Uint8Array,wt=Tf;function Af(t){var e=new t.constructor(t.byteLength);return new wt(e).set(new wt(t)),e}var $=Af;function Of(t,e){var r=e?$(t.buffer):t.buffer;return new t.constructor(r,t.byteOffset,t.byteLength)}var ze=Of;var _f=/\w*$/;function Pf(t){var e=new t.constructor(t.source,_f.exec(t));return e.lastIndex=t.lastIndex,e}var Ve=Pf;var He=A?A.prototype:void 0,qe=He?He.valueOf:void 0;function Sf(t){return qe?Object(qe.call(t)):{}}var $e=Sf;function If(t,e){var r=e?$(t.buffer):t.buffer;return new t.constructor(r,t.byteOffset,t.length)}var Ye=If;var Cf="[object Boolean]",Ef="[object Date]",Lf="[object Map]",Mf="[object Number]",Rf="[object RegExp]",Ff="[object Set]",Bf="[object String]",Df="[object Symbol]",Nf="[object ArrayBuffer]",Uf="[object DataView]",Wf="[object Float32Array]",Gf="[object Float64Array]",kf="[object Int8Array]",Kf="[object Int16Array]",zf="[object Int32Array]",Vf="[object Uint8Array]",Hf="[object Uint8ClampedArray]",qf="[object Uint16Array]",$f="[object Uint32Array]";function Yf(t,e,r){var o=t.constructor;switch(e){case Nf:return $(t);case Cf:case Ef:return new o(+t);case Uf:return ze(t,r);case Wf:case Gf:case kf:case Kf:case zf:case Vf:case Hf:case qf:case $f:return Ye(t,r);case Lf:return new o;case Mf:case Bf:return new o(t);case Rf:return Ve(t);case Ff:return new o;case Df:return $e(t)}}var Je=Yf;function Jf(t){return typeof t.constructor=="function"&&!N(t)?Dt(lt(t)):{}}var Xe=Jf;var Xf="[object Map]";function Zf(t){return w(t)&&q(t)==Xf}var Ze=Zf;var Qe=P&&P.isMap,Qf=Qe?U(Qe):Ze,tr=Qf;var ts="[object Set]";function es(t){return w(t)&&q(t)==ts}var er=es;var rr=P&&P.isSet,rs=rr?U(rr):er,or=rs;var os=1,as=2,fs=4,ar="[object Arguments]",ss="[object Array]",is="[object Boolean]",ns="[object Date]",ps="[object Error]",fr="[object Function]",ls="[object GeneratorFunction]",ms="[object Map]",us="[object Number]",sr="[object Object]",ds="[object RegExp]",cs="[object Set]",xs="[object String]",hs="[object Symbol]",gs="[object WeakMap]",ys="[object ArrayBuffer]",bs="[object DataView]",vs="[object Float32Array]",js="[object Float64Array]",ws="[object Int8Array]",Ts="[object Int16Array]",As="[object Int32Array]",Os="[object Uint8Array]",_s="[object Uint8ClampedArray]",Ps="[object Uint16Array]",Ss="[object Uint32Array]",n={};n[ar]=n[ss]=n[ys]=n[bs]=n[is]=n[ns]=n[vs]=n[js]=n[ws]=n[Ts]=n[As]=n[ms]=n[us]=n[sr]=n[ds]=n[cs]=n[xs]=n[hs]=n[Os]=n[_s]=n[Ps]=n[Ss]=!0;n[ps]=n[fr]=n[gs]=!1;function gt(t,e,r,o,s,i){var f,a=e&os,p=e&as,m=e&fs;if(r&&(f=s?r(t,o,s,i):r(t)),f!==void 0)return f;if(!T(t))return t;var j=D(t);if(j){if(f=Ke(t),!a)return Nt(t,f)}else{var h=q(t),y=h==fr||h==ls;if(st(t))return Ee(t,a);if(h==sr||h==ar||y&&!s){if(f=p||y?{}:Xe(t),!a)return p?Fe(t,_e(f,t)):Re(t,Oe(f,t))}else{if(!n[h])return s?t:{};f=Je(t,h,a)}}i||(i=new Ae);var b=i.get(t);if(b)return b;i.set(t,f),or(t)?t.forEach(function(g){f.add(gt(g,e,r,g,t,i))}):tr(t)&&t.forEach(function(g,v){f.set(v,gt(g,e,r,v,t,i))});var c=m?p?De:Be:p?G:W,R=j?void 0:c(t);return Ut(R||t,function(g,v){R&&(v=g,g=t[v]),ot(f,v,gt(g,e,r,v,t,i))}),f}var ir=gt;var Is=1,Cs=4;function Es(t){return ir(t,Is|Cs)}var Tt=Es;var At=(t=21)=>crypto.getRandomValues(new Uint8Array(t)).reduce((e,r)=>(r&=63,r<36?e+=r.toString(36):r<62?e+=(r-26).toString(36).toUpperCase():r>62?e+="-":e+="_",e),"");var Ot=class{settings={devMode:!0,mode:"detect",modeTimeout:300,siteUrl:"https://tera-tools.com/embed",restrictOrigin:"*"};dom={el:null,iframe:null,stylesheet:null};methods=["handshake","getUser","bindProject","getProject","getProjects","setActiveProject","requireProject","selectProject","getProjectState","applyProjectStatePatch","subscribeProjectState","getProjectFiles","getProjectLibrary","setProjectLibrary"];plugins=[];send(e){let r=At();return this.acceptPostboxes[r]={},this.acceptPostboxes[r].promise=new Promise((o,s)=>{Object.assign(this.acceptPostboxes[r],{resolve:o,reject:s}),this.sendRaw({id:r,...e})}),this.acceptPostboxes[r].promise}sendRaw(e){let r;try{if(r={TERA:1,id:e.id||At(),...Tt(e)},this.settings.mode=="parent")window.parent.postMessage(r,this.settings.restrictOrigin);else if(this.settings.mode=="child")this.dom.iframe.contentWindow.postMessage(r,this.settings.restrictOrigin);else throw this.settings.mode=="detect"?new Error("Call init() or detectMode() before trying to send data to determine the mode"):new Error(`Unknown TERA communication mode "${this.settings.mode}"`)}catch(o){throw this.debug("ERROR","Message compose client->server:",o),this.debug("ERROR","Attempted to dispatch payload client->server",r),o}}rpc(e,...r){return this.send({action:"rpc",method:e,args:r})}acceptMessage(e){if(e.origin==window.location.origin)return;let r=e.data;if(!(!r.TERA||!r.id))if(this.debug("Recieved",r),r?.action=="response"&&this.acceptPostboxes[r.id])r.isError===!0?this.acceptPostboxes[r.id].reject(r.response):this.acceptPostboxes[r.id].resolve(r.response);else{if(r?.action=="rpc")return Promise.resolve().then(()=>this[r.method].apply(this,r.args)).then(o=>this.sendRaw({id:r.id,action:"response",response:o})).catch(o=>{console.warn(`TERA-FY client threw on RPC:${r.method}:`,o),this.sendRaw({id:r.id,action:"response",isError:!0,response:o.toString()})});r?.id?this.debug(`Ignoring message ID ${r.id} - was meant for someone else?`):this.debug("Unexpected incoming TERA-FY CLIENT message",{message:r})}}acceptPostboxes={};createProjectStatePatch(e,r){let o=_t(r,e,Pt);return this.debug("INFO","Created project patch",{newState:e,oldState:r}),this.applyProjectStatePatch(o)}applyProjectStatePatchLocal(e){return this.debug("WARN","Accepted project patch",e,"but applyProjectStatePatchLocal() has not been sub-classed"),Promise.resolve()}constructor(e){e&&this.set(e)}init(e){if(e&&this.set(e),this.init.promise)return this.init.promise;window.addEventListener("message",this.acceptMessage.bind(this));let r=this;return this.init.promise=Promise.resolve().then(()=>this.detectMode()).then(o=>this.settings.mode=o).then(()=>Promise.all([this.injectComms(),this.injectStylesheet(),this.injectMethods()])).then(()=>Promise.all(this.plugins.map(o=>o.init.call(r))))}detectMode(){return this.settings.mode!="detect"?this.settings.mode:window.self===window.parent?"child":Promise.resolve().then(()=>this.settings.mode="parent").then(()=>new Promise((e,r)=>{let o=setTimeout(()=>r(),this.settings.modeTimeout);this.rpc("handshake").then(()=>clearTimeout(o)).then(()=>e())})).then(()=>"parent").catch(()=>"child")}injectComms(){return new Promise(e=>{switch(this.settings.mode){case"child":this.dom.el=document.createElement("div"),this.dom.el.id="tera-fy",this.dom.el.classList.toggle("dev-mode",this.settings.devMode),document.body.append(this.dom.el),this.dom.iframe=document.createElement("iframe"),this.dom.iframe.setAttribute("sandbox","allow-downloads allow-scripts allow-same-origin"),this.dom.iframe.addEventListener("load",()=>{this.debug("Embed frame ready"),e()}),this.dom.iframe.src=this.settings.siteUrl,this.dom.el.append(this.dom.iframe);break;case"parent":e();break;default:throw new Error(`Unsupported mode "${this.settings.mode}" when calling injectComms()`)}})}injectStylesheet(){switch(this.settings.mode){case"child":this.dom.stylesheet=document.createElement("style"),this.dom.stylesheet.innerHTML=[":root {","--TERA-accent: #4d659c;","}","#tera-fy {","display: none;","position: fixed;","right: 50px;","bottom: 50px;","width: 300px;","height: 150px;","background: transparent;","&.dev-mode {","display: flex;","border: 5px solid var(--TERA-accent);","background: #FFF;","}","& > iframe {","width: 100%;","height: 100%;","}","}","body.tera-fy-focus {","overflow: hidden;","& #tera-fy {","display: flex !important;","position: fixed !important;","top: 0px !important;","width: 100vw !important;","height: 100vh !important;","left: 0px !important;","z-index: 10000 !important;","}","}"].join(`
`),document.head.appendChild(this.dom.stylesheet);break;case"parent":break;default:throw new Error(`Unsupported mode "${this.settings.mode}" when injectStylesheet()`)}}injectMethods(){this.methods.forEach(e=>this[e]=this.rpc.bind(this,e))}debug(...e){let r="log";typeof e[0]=="string"&&["INFO","LOG","WARN","ERROR"].includes(e[0])&&(r=e.shift().toLowerCase()),!(["INFO","LOG"].includes(r)&&!this.settings.devMode)&&console[r]("%c[TERA-FY CLIENT]","font-weight: bold; color: #ff5722;",...e)}set(e,r){return typeof e=="string"?this.settings[e]=r:Object.assign(this.settings,e),this.toggleDevMode(this.settings.devMode)}use(e,r){if(typeof e!="function")throw new Error("Expected use() call to be provided with a class initalizer");let o=new e(this,r);return this.mixin(this,o),this.plugins.push(o),this}mixin(e,r){Object.getOwnPropertyNames(Object.getPrototypeOf(r)).filter(o=>!["constructor","prototype","name"].includes(o)).filter(o=>o!="init").forEach(o=>{Object.defineProperty(e,o,{value:r[o].bind(e),enumerable:!1})})}toggleDevMode(e="toggle"){return this.settings.devMode=e==="toggle"?!this.settings.devMode:e,this.dom.el&&this.dom.el.classList.toggle("dev-mode",this.settings.devMode),this}toggleFocus(e="toggle"){this.debug("Request focus",{isFocused:e}),globalThis.document.body.classList.toggle("tera-fy-focus",e==="toggle"?void 0:e)}};export{Ot as default};
/*! Bundled license information:

lodash-es/lodash.js:
  (**
   * @license
   * Lodash (Custom Build) <https://lodash.com/>
   * Build: `lodash modularize exports="es" -o ./`
   * Copyright OpenJS Foundation and other contributors <https://openjsf.org/>
   * Released under MIT license <https://lodash.com/license>
   * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
   * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
   *)
*/
//# sourceMappingURL=terafy.js.map
